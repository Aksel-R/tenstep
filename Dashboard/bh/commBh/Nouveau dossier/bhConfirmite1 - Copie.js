<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <!-- Meta, title, CSS, favicons, etc. -->
  
  <link rel="stylesheet" href="/sites/bhcom/_catalogs/masterpage/ConformiteControle/css/bootstrap.min.css" >
  <link rel="stylesheet" href="/sites/bhcom/_catalogs/masterpage/ConformiteControle/css/bootstrap.css" >
  <link rel="stylesheet" href="/sites/bhcom/_catalogs/masterpage/ConformiteControle/css/style.css" >
  <link rel="stylesheet" href="/sites/bhcom/_catalogs/masterpage/ConformiteControle/css/achevement.css"  >
  <link rel="stylesheet" href="/sites/bhcom/_catalogs/masterpage/ConformiteControle/css/w3.css" >
  <link rel="stylesheet" href="/sites/bhcom/_catalogs/masterpage/ConformiteControle/css/fontawesome.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
  


  <!-- Font Awesome -->
  <!-- NProgress -->
 <style type="text/css">
  .navbar-inverse {
            background-color: #cf232a;
            border-color: #cf232a;
        }


        .btn-group-vertical>.btn-group:after,
        .btn-group-vertical>.btn-group:before,
        .btn-toolbar:after,
        .btn-toolbar:before,
        .clearfix:after,
        .clearfix:before,
        .container1-fluid:after,
        .container1-fluid:before,
        .container1:after,
        .container1:before,
        .dl-horizontal dd:after,
        .dl-horizontal dd:before,
        .form-horizontal .form-group:after,
        .form-horizontal .form-group:before,
        .modal-footer:after,
        .modal-footer:before,
        .modal-header:after,
        .modal-header:before,
        .nav:after,
        .nav:before,
        .navbar-collapse:after,
        .navbar-collapse:before,
        .navbar-header:after,
        .navbar-header:before,
        .navbar:after,
        .navbar:before,
        .pager:after,
        .pager:before,
        .panel-body:after,
        .panel-body:before,
        .row:after,
        .row:before {
            display: none;
            content: " ";
        }
        span#DeltaPlaceHolderPageTitleInTitleArea {
    display: none;
}
th {
    font-size: smaller;
}
text.highcharts-credits {
    display: none;
}
.panel-primary {
    border-color: #cf232a;
    box-shadow: 0px 4px 8px 0px rgb(0 0 0);
    border-radius: 6px;
}

.panel-primary>.panel-heading {
    color: #fff;
    background-color: linear-gradient;
    border-color: #cf232a;
    background: linear-gradient(45deg, #cf232a, #506979);
}



.html5-progress-bar {
    padding: 100px 15px;
    border-radius: 3px;
    background-color: #fff;
    box-shadow: 0px 1px 2px 0px rgba(0, 0, 0, .2);
}
.html5-progress-bar progress {
    background-color: #f3f3f3;
    border: 0;
    width: 80%;
    height: 18px;
    border-radius: 9px;
    box-shadow: 0px 4px 8px 0px rgb(0 0 0);
}
.html5-progress-bar progress::-webkit-progress-bar {
    background-color: #f3f3f3;
    border-radius: 9px;
}
.html5-progress-bar progress::-webkit-progress-value {
    background: #cdeb8e;
    background: -moz-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #cdeb8e), color-stop(100%, #a5c956));
    background: -webkit-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: -o-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: -ms-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: linear-gradient(to bottom, #cdeb8e 0%, #a5c956 100%);
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#cdeb8e', endColorstr='#a5c956', GradientType=0);
    border-radius: 9px;

}
.html5-progress-bar progress::-moz-progress-bar {
    background: #cdeb8e;
    background: -moz-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #cdeb8e), color-stop(100%, #a5c956));
    background: -webkit-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: -o-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: -ms-linear-gradient(top, #cdeb8e 0%, #a5c956 100%);
    background: linear-gradient(to bottom, #cdeb8e 0%, #a5c956 100%);
    filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#cdeb8e', endColorstr='#a5c956', GradientType=0);
    border-radius: 9px;
}
.html5-progress-bar .progress-value {
    padding: 0px 5px;
    line-height: 20px;
    margin-left: 5px;
    font-size: .8em;
    color: #555;
    height: 18px;
    float: right;
    font-size: larger;
    font-weight: bold;
}

.panel-body {
    height: 600px;
}
svg.highcharts-root {
  width: 100%;
}
highcharts-chart { display: block, width: 100%, height: auto }

.panel-primary>.panel-heading1 {
    color: #fff;
    background-color: #cf232a;
    border-color: #cf232a;
}
  </style>



</head>
<body style="font-family: serif;">


<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" style="border-radius: 5px; box-shadow: 0px 4px 8px 0px rgb(0 0 0 / 100%);">


    <div class="form-check1">
      <input class="form-check1-input" type="radio" name="flexRadioDefault" id="flexRadioDefault1" checked>
      <label class="form-check1-label" for="flexRadioDefault1" style="color: white;padding-top: 13%;">
        Date Journé
      </label>
    </div>
    <div class="form-check1">
      <input class="form-check1-input" type="radio" name="flexRadioDefault" id="flexRadioDefault2" >
      <label class="form-check1-label" for="flexRadioDefault2" style="color: white;padding-top: 7%;">
        Date dernière contrôle 
      </label>
    </div>
    <div class="form-check1">
      <button type="button" class="btn btn-primary"  id="valider1">Valider</button>
    </div>
    
 

</nav>

<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" style="border-radius: 5px; box-shadow: 0px 4px 8px 0px rgb(0 0 0 / 100%);">

  
    <div class="form-check-rad">
      <input class="form-check-rad-input" type="radio" name="flexRadioDefaultRad" id="flexRadioDefault1Rad" disabled />
      <label class="form-check-rad-label" for="flexRadioDefault1" style="color: white;padding-top: 9%;"> Interval du Temps </label>
    </div>
    <div class="form-check2">
      <input type="date" id="start" name="trip-start" disabled>
      <input type="date" id="finish" name="trip-start" disabled>
    </div>
    
    <div class="form-check-rad">
      <input class="form-check-rad-input" type="radio" name="flexRadioDefaultRad" id="flexRadioDefault2Rad" checked disabled/>
      <label class="form-check-rad-label" for="flexRadioDefault2" style="color: white;padding-top: 18%;"> Période </label>
    </div>
    <select class="mdb-select md-form" disabled style="float: left; width: 20%; background-color: #cf232a; color: azure; font-size: 20px; border-radius: 5px ;  border-color: azure;" id="myList01" onchange="loadSel02();">
                <option value="Mensuel">Mensuel</option>
                <option value="Trimestriel">Trimestriel</option>
                <option value="Annuel">Annuel</option>

    </select>
    <select class="mdb-select md-form" disabled style="float: left; width: 20%; background-color: #cf232a; color: azure; font-size: 20px; border-radius: 5px ;  border-color: azure;" id="myList02" onchange="">
                

    </select>

    <div class="form-check-rad">
      <button type="button" class="btn btn-primary" id="valider2" disabled>Valider</button>
    </div>

</nav>

 <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" style="border-radius: 5px; box-shadow: 0px 4px 8px 0px rgb(0 0 0 / 100%);">
  
    <ul class="nav navbar-right top-nav"  style="padding-left: 0px; padding-right: 0px;width: 50%;">
        <h5 id="titre" style="color: white; float: left; margin-bottom: 0px;margin-top: 0px;">Conformité Contrôle Permanant et Sécurité Financière
        </h5>
    </ul>
    <select class="mdb-select md-form" disabled
                style="float: left; width: 20%; background-color: #cf232a; color: azure; font-size: 20px; border-radius: 5px ;  border-color: azure;"
                id="myList1" onchange="remplirSel();mainFilter();">
                <option value="">Direction Régionale</option>

            </select>
            <select class="mdb-select md-form" disabled
                style="float: left; width: 20%; background-color: #cf232a; color: azure; font-size: 20px; border-radius: 5px ;  border-color: azure;"
                id="myList2" onchange="mainFilter();">
                <option value="">Agence</option>

            </select>
  

</nav>

<div class="row" id="row1">
     <div class="col-lg-12">
        <div class="panel panel-primary" >
            <div class="panel-heading" style="height: 53px;">
                <h3 class="panel-title"><i class="fa fa-clock-o"></i> Taux Anomalies par CR
                </h3>
            </div>
            <div class="panel-body" style="padding: 0px 15px;height: auto;">
              <div class="row">
                
                <div class="col-lg-6" id="div-container1">
                  <div id="container1"></div>
                </div> 
                
                <div class="col-lg-6" id="tauxG">
                  <div class="col-lg-6">
                    <div class="row" id="image1">
                      
                    </div>
                    <div class="row" id="value1">
                      
                    </div>
                    <div class="row" id="titre1">
                      
                    </div>
                  </div>
                  <div class="col-lg-6">
                    <div class="row" id="image2">
                      
                    </div>
                    <div class="row" id="value2">
                      
                    </div>
                    <div class="row" id="titre2">
                      
                    </div>
                  </div>
                </div>
                <div class="col-lg-12" id="div-container2">
                  <div id="container2"></div>
                </div>
              </div>            
            </div>
          </div> 
    </div>
    
</div>

<div class="row" id="row01">
  <div class="col-lg-12">
          <div class="panel panel-primary">
            <div class="panel-heading" style="height: 53px;">
              <div class="col-lg-6">
                <h3 class="panel-title"><i class="fa fa-clock-o"></i> Répartition des CR </h3>
              </div>
              <div class="col-lg-6" style="float: right; ">
                <div class="col-lg-10" >
                  <h3 class="panel-title"style="font-size: 20px;text-align: right;color: #ffffff;font-weight: 500;"><i class="fa fa-bar-chart"></i> Nombre des CR: </h3>
                </div>
                <div class="col-lg-2"><p class="card-text" style="font-size: 20px;text-align: left;color: #ffffff;font-weight: 500;" id="NbCR"></p></div>
                
              </div>
              <!-- <div class="col-lg-4">
                <div class="col-lg-8">
                  <h3 class="panel-title"style="font-size: 15px;text-align: right;"><i class="fa fa-bar-chart"></i> Moyenne Anomalie/Journée: </h3>
                </div>
                <div class="col-lg-4"><p class="card-text" style="font-size: 15px;text-align: left;" id="MoyAnnJr1"></p></div>
                
              </div> -->
                
            </div>
            <div class="panel-body" style="padding: 0px 15px;">
              <div class="col-lg-12" id="div-container4">
                <div id="container4" style="width:100%;"></div>
              </div>
                         
            </div>
          </div> 
    </div>
</div>   
<div class="row" id="row2">
  <div class="col-lg-12">
          <div class="panel panel-primary">
            <div class="panel-heading" style="height: 53px;">
              <div class="col-lg-6">
                <h3 class="panel-title"><i class="fa fa-clock-o"></i> Répartition des Anomalies </h3>
              </div>
              <div class="col-lg-6" style="float: right;">
                <div class="col-lg-10" >
                  <h3 class="panel-title"style="font-size: 20px;text-align: right;color: #ffffff;font-weight: 500;"><i class="fa fa-bar-chart"></i> Nombre des anomalies: </h3>
                </div>
                <div class="col-lg-2"><p class="card-text" style="font-size: 20px;text-align: left;color: #ffffff;font-weight: 500;" id="NbAnn"></p></div>
                
              </div>
              <!-- <div class="col-lg-4">
                <div class="col-lg-8">
                  <h3 class="panel-title"style="font-size: 15px;text-align: right;"><i class="fa fa-bar-chart"></i> Moyenne Anomalie/Journée: </h3>
                </div>
                <div class="col-lg-4"><p class="card-text" style="font-size: 15px;text-align: left;" id="MoyAnnJr1"></p></div>
                
              </div> -->
                
            </div>
            <div class="panel-body" style="padding: 0px 15px;">
              <div class="col-lg-12" id="div-container5">
                <div id="container5" style="width:100%;"></div>
              </div>
                         
            </div>
          </div> 
    </div>
</div>    
<div class="row" id="row03">
  <div class="col-lg-12">
          <div class="panel panel-primary">
            <div class="panel-heading" style="height: 53px;">
              <div class="col-lg-6">
                <h3 class="panel-title"><i class="fa fa-clock-o"></i> Taux des anomalies par CR </h3>
              </div>
              <div class="col-lg-6" style="float: right;">
                <div class="col-lg-10" >
                  <h3 class="panel-title"style="font-size: 20px;text-align: right;color: #ffffff;font-weight: 500;"><i class="fa fa-bar-chart"></i> Moyenne Anomalie/CR: </h3>
                </div>
                <div class="col-lg-2"><p class="card-text" style="font-size: 20px;text-align: left;color: #ffffff;font-weight: 500;" id="MoyAnnJr"></p></div>
                
              </div>
              <!-- <div class="col-lg-4">
                <div class="col-lg-8">
                  <h3 class="panel-title"style="font-size: 15px;text-align: right;"><i class="fa fa-bar-chart"></i> Moyenne Anomalie/Journée: </h3>
                </div>
                <div class="col-lg-4"><p class="card-text" style="font-size: 15px;text-align: left;" id="MoyAnnJr1"></p></div>
                
              </div> -->
                
            </div>
            <div class="panel-body" style="padding: 0px 15px;">
              <div class="col-lg-12" id="div-container44">
                <div id="container44" style="width:100%;"></div>
              </div>
                         
            </div>
          </div> 
    </div>
</div>     
 

</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/jquery-3.5.1.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/highcharts.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/valider1.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/valider2.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/sel02.js"></script>

<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/conToKM.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/filter - Copie.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/filter1 - Copie.js"></script>
<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/Mysel1 - Copie.js"></script>



<script src="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/accessibility.js"></script>

<script type="/sites/bhcom/_catalogs/masterpage/ConformiteControle/javascript/custom.min.js"></script>

<script type="text/javascript"> 
  document.getElementById("valider1").onclick=valider1;
  document.getElementById("flexRadioDefault1Rad").onclick=change1;
  document.getElementById("flexRadioDefault2Rad").onclick=change2;
  document.getElementById("valider2").onclick=valider2;
      var responseRegion=responseRegion||[];
  var urlRegion=_spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('Agences')/items?$select=Direction_x0020_R_x00e9_gionale";
  ////////////////////console.log.log('urlRegion= '+urlRegion);
  function LoadRegion() {
            var nbre = 0;


            $.ajax({
                url: urlRegion,
                method: "GET",
                dataType: "json",
                headers: { Accept: "application/json;odata=verbose" },
                success: function (data) {
                    responseRegion = responseRegion.concat(data.d.results);
                    if (data.d.__next) {
                        urlRegion = data.d.__next;
                        LoadRegion();
                    }
                   
                    $.each(responseRegion, function (key, value) {
                      var region=value.Direction_x0020_R_x00e9_gionale;
                      $('#myList1').append($('<option>',
                         {
                            text : region,
                            value:region
                          })); 
                          var opt = {};
                            $("#myList1 > option").each(function () {
                              if(opt[$(this).text()]) {
                                  $(this).remove();
                              } else {
                                  opt[$(this).text()] = $(this).val();
                              }
                             });
                    });
                  
                    
                    
                }
            });
        }
        LoadRegion();

        var arrUserId=[];
        var arrUserName=[];
        

         var responseAgence=responseAgence||[];
    var urlAgence=_spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('Agences')/items?$select=Title,ID";
    //////////////////////console.log.log('urlAgence= '+urlAgence);
    function LoadAgence() {
              var nbre = 0;


              $.ajax({
                  url: urlAgence,
                  method: "GET",
                  dataType: "json",
                  headers: { Accept: "application/json;odata=verbose" },
                  success: function (data) {
                      responseAgence = responseAgence.concat(data.d.results);
                      if (data.d.__next) {
                          urlAgence = data.d.__next;
                          LoadAgence();
                      }
                     
                      $.each(responseAgence, function (key, value) {
                        var agence=value.Title;
                        var idAg=value.ID;
                        $('#myList2').append($('<option>',
                           {
                              text : agence,
                              value:idAg
                            })); 
                            var opt = {};
                              $("#myList2 > option").each(function () {
                                if(opt[$(this).text()]) {
                                    $(this).remove();
                                } else {
                                    opt[$(this).text()] = $(this).val();
                                }
                               });
                      });
                    
                      
                      
                  }
              });
          }
          LoadAgence();

function moisSelect() {
  moment.locale('fr');
  var arrMois=[];
  var arrMois1=[];
  var moisActuel= moment().format('YYYY-MM-DD');
  var dateCount= moment([2021, 1, 1]).format('YYYY-MM-DD');
  dateCount=moment(dateCount).add(-1, 'months');
  do {
    arrMois.push(moment(dateCount).format('YYYY-MM'));
    arrMois1.push(moment(dateCount).format('YYYY-MM-DD'));
    dateCount=moment(dateCount).add(1, 'months');
  } while (moment(dateCount).isSameOrBefore(moisActuel));
  
  var finalArrMois=arrMois.reverse();
  var finalArrMois1=arrMois1.reverse();
  //console.log("finalArrMois= "+finalArrMois);
  for (var i = 0; i < finalArrMois.length; i++) {
    $('#myList02').append($('<option>',
    {
      text : finalArrMois[i],
      value:finalArrMois1[i]
    })); 
    var opt = {};
    $("#myList02 > option").each(function () {
      if(opt[$(this).text()]) {
          $(this).remove();
      } else {
          opt[$(this).text()] = $(this).val();
      }
    });
  }
}
moisSelect();




     var responseAgenceNumber=responseAgenceNumber||[];
    var urlAgenceNumber=_spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('Agences')/items?$select=Title,ID";
    console.log('urlAgenceNumber= '+urlAgenceNumber);
    function LoadAgenceNumber() {
              var nbre = 0;


              $.ajax({
                  url: urlAgenceNumber,
                  method: "GET",
                  dataType: "json",
                  headers: { Accept: "application/json;odata=verbose" },
                  success: function (data) {
                      responseAgenceNumber = responseAgenceNumber.concat(data.d.results);
                      if (data.d.__next) {
                          urlAgenceNumber = data.d.__next;
                          LoadAgenceNumber();
                      }else if (!(data.d.__next)) {
                        var nbAg=0;
                        $.each(responseAgenceNumber, function (key, value) {
                          nbAg++;
                        });
                      loadContrlInfo(nbAg)

                      }
                      
                  }
              });
          }
          LoadAgenceNumber();
function loadContrlInfo(nbAg) {
  
  moment.locale('fr');
   var startOfMonth1= moment().startOf('month').format('YYYY-MM-DD');
   var endOfMonth1 = moment().endOf('month').format('YYYY-MM-DD');
   var urlDateDebut1=startOfMonth1+'T00:00:00.000';
   var urlDateFin1=endOfMonth1+'T00:00:00.000';
   var responseCouverture=responseCouverture || []
   var urlCouverture=_spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('ControlPlus')/items?$filter=Date_x0020_Journ_x00e9_e ge datetime'"+urlDateDebut1+"' and Date_x0020_Journ_x00e9_e le datetime'"+urlDateFin1+"'";
    console.log('urlCouverture= '+urlCouverture);
    function loadCouverture() {
              


              $.ajax({
                  url: urlCouverture,
                  method: "GET",
                  dataType: "json",
                  headers: { Accept: "application/json;odata=verbose" },
                  success: function (data) {
                      responseCouverture = responseCouverture.concat(data.d.results);
                      if (data.d.__next) {
                          urlCouverture = data.d.__next;
                          loadCouverture();
                      }

                      else if (!data.d.__next) {
                        var nbJrsTheo=21;
                        var nbJrsControle=0;
                        $.each(responseCouverture, function (key, value) {
                          nbJrsControle++;
                        });
                        var tauxCouverture = parseFloat((nbJrsControle/parseFloat(nbAg*nbJrsTheo))*100);
                        
                        var comTaux=parseFloat(100-tauxCouverture);
                        var moisAnnAct1111=moment().format("MM-YYYY");
                         
                        document.getElementById("container1").innerHTML ='<h1>Taux de couverture</h1>'+
                        '<div class="demo-wrapper html5-progress-bar">'+
                            '<div class="progress-bar-wrapper">'+
                                '<progress id="progressbar" value="'+tauxCouverture+'" max="100"></progress> <span class="progress-value">'+parseFloat(tauxCouverture).toFixed(3)+'%</span>'+

                            '</div>'+
                        '</div>';
                        
                     }
                      
                    
                      
                      
                  }
              });
          }
        loadCouverture();
}


//***********************************************************************************************************************************************
  moment.locale('fr');
   var startOfMonth= moment().startOf('month').format('YYYY-MM-DD');
   var endOfMonth = moment().endOf('month').format('YYYY-MM-DD');
   var urlDateDebut=startOfMonth+'T00:00:00.000';
   var urlDateFin=endOfMonth+'T00:00:00.000';
   var colors=["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850","#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9"];
   var colors1=["#cf232a","#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850","#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9"];
    var responseReparationCR=responseReparationCR || []
   var urlReparationCR=_spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('ControlPlus')/items?$filter=Date_x0020_Journ_x00e9_e ge datetime'"+urlDateDebut+"' and Date_x0020_Journ_x00e9_e le datetime'"+urlDateFin+"' and Avis_x0020_DCP%20eq%27Vérifiée%27";
    console.log('urlReparationCR= '+urlReparationCR);
    function LoadCharts() {
              var nbre = 0;


              $.ajax({
                  url: urlReparationCR,
                  method: "GET",
                  dataType: "json",
                  headers: { Accept: "application/json;odata=verbose" },
                  success: function (data) {
                      responseReparationCR = responseReparationCR.concat(data.d.results);
                      if (data.d.__next) {
                          urlReparationCR = data.d.__next;
                          LoadCharts();
                      }
                      else if (!data.d.__next) {
                        var arrRegionalDir=["DIRECTION REGIONALE TUNIS Médina","DIRECTION REGIONALE DU NORD","DIRECTION REGIONALE TUNIS NORD","DIRECTION REGIONALE TUNIS SUD  ET CAP BON","DIRECTION REGIONALE DU SUD","DIRECTION REGIONALE DU SAHEL","DIRECTION REGIONALE SFAX ET CENTRE"];
                        var arrCRCount=[0,0,0,0,0,0,0];
                        var arrCRAnomalie=[0,0,0,0,0,0,0];
                        //******************************************
                        var arrCRConformeSum=[0,0,0,0,0,0,0];
                        var arrCRTotal=[0,0,0,0,0,0,0];
                        var arrCRPercent=[0,0,0,0,0,0,0];
                        //******************************************
                        var arrMois=[];
                        var arrSumMoiCr=[];
                        var arrSumMoiAnnomalie=[];

                        var sumCr=0;
                        var sumAnn=0;
                        $.each(responseReparationCR, function (key, value) {
                          sumCr++;
                          var region=value.R_x00e9_gion_x0020_de_x0020_l_x0;
                          arrCRCount[arrRegionalDir.indexOf(region)]=parseInt(arrCRCount[arrRegionalDir.indexOf(region)]+1);
                          var nbNonConforme=0;
                          if (value.N_x00b0__x0020_Non_x0020_Conform!=null) {
                            nbNonConforme=value.N_x00b0__x0020_Non_x0020_Conform;
                          }
                          arrCRAnomalie[arrRegionalDir.indexOf(region)]=parseInt(arrCRAnomalie[arrRegionalDir.indexOf(region)]+nbNonConforme);
                            sumAnn=parseInt(sumAnn+nbNonConforme);

                          var nbConforme=0;
                          if (value.N_x00b0__x0020_Conforme!=null) {
                            nbConforme=value.N_x00b0__x0020_Conforme;
                          }
                          arrCRConformeSum[arrRegionalDir.indexOf(region)]=parseInt(arrCRConformeSum[arrRegionalDir.indexOf(region)]+nbConforme);
                          var totalCoonn=0;
                          totalCoonn=parseInt(nbConforme+nbNonConforme);
                          arrCRTotal[arrRegionalDir.indexOf(region)]=parseInt(arrCRTotal[arrRegionalDir.indexOf(region)]+totalCoonn);
                        });
                        

                        //console.log("/__________________________________________________________________________________________/");
                        //console.log("arrCRConformeSum= "+arrCRConformeSum);
                        //console.log("arrCRTotal= "+arrCRTotal);
                        //console.log("arrCRPercent= "+arrCRPercent);
                        //console.log("/__________________________________________________________________________________________/");
                          ////console.log("arrCRCount= "+arrCRCount);
                          var moisAct=moment().format("MM-YYYY");
                          arrMois.push(moisAct);
                          arrSumMoiCr.push(sumCr);
                          arrSumMoiAnnomalie.push(sumAnn);
                          var debMoisAct=moment().startOf('month').format('YYYY-MM-DD');
                          for (var i = 1; i < 2; i++) {
                            monthAdd=parseInt(i)*-1;
                            var date1=moment(debMoisAct).add(monthAdd, 'months').format('YYYY-MM-DD');
                            var date2=moment(date1).add(1, 'months').format('YYYY-MM-DD');
                            var label=moment(date1).format('MM-YYYY')
                            loadPreviousInfo(arrMois,arrSumMoiCr,arrSumMoiAnnomalie,date1,date2,label,i);
                          }
                          
                          var moisAnnAct=moment().format("MM-YYYY");
                        var moyAnJr=0;
                        var sumAnJr=0; 
                        var sumAnJr1=0;
                        var sumAnJr2=0; 
                        for (var i = 0; i < arrCRPercent.length; i++) {
                          if (arrCRCount[i]!=0) {
                            var newPercent=parseFloat(arrCRAnomalie[i]/arrCRCount[i]).toFixed(2);
                            sumAnJr+=parseFloat(newPercent);
                            arrCRPercent[i]=parseFloat(newPercent);
                            sumAnJr1+=parseFloat(arrCRCount[i]);
                            sumAnJr2+=parseFloat(arrCRAnomalie[i]);
                          }
                        }

                        moyAnJr=0;
                        if (sumAnJr1!=0) {
                          moyAnJr=parseFloat(sumAnJr2/sumAnJr1).toFixed(2);
                        }
                        var ss1=0;
                        for (var i = 0; i < arrCRPercent.length; i++) {
                          ss1+=parseFloat(arrCRPercent[i]);
                        }
                        var mm1=parseFloat(ss1/arrCRPercent.length).toFixed(2);
                        //document.getElementById("MoyAnnJr1").innerHTML =mm1; NbCR NbAnn
                        //
                        document.getElementById("MoyAnnJr").innerHTML =moyAnJr;
                        document.getElementById("NbCR").innerHTML =parseFloat(sumAnJr1).toFixed(0);
                        document.getElementById("NbAnn").innerHTML =parseFloat(sumAnJr2).toFixed(0);
                        //********************************************************************************************************
                        Highcharts.chart('container4', {
                          chart: {
                              type: 'column'
                          },
                          xAxis: {
                              categories: arrRegionalDir
                          },

                          plotOptions: {
                              series: {
                                  dataLabels: {
                                      enabled: true,
                                      align: 'right',
                                      color: '#FFFFFF',
                                      x: -10
                                  },
                                  pointPadding: 0.1,
                                  groupPadding: 0
                              }
                          },
                            colors: colors,
                            title: {
                                text: 'Répartition des CR par Direction (mois '+moisAnnAct+')'
                            },

                          series: [{
                              name: "Contrôle Régioneaux",
                              data: arrCRCount
                          }]
                      });
                      //******************************************************************************************************************************
                      Highcharts.chart('container5', {
                          chart: {
                              type: 'column'
                          },
                          xAxis: {
                              categories: arrRegionalDir
                          },

                          plotOptions: {
                              series: {
                                  dataLabels: {
                                      enabled: true,
                                      align: 'right',
                                      color: '#FFFFFF',
                                      x: -10
                                  },
                                  pointPadding: 0.1,
                                  groupPadding: 0
                              }
                          },
                            colors: colors1,
                            title: {
                                text: 'Répartition des Anomalies par Direction (mois '+moisAnnAct+')'
                            },

                          series: [{
                              name: "Anomalies",
                              data: arrCRAnomalie
                          }]
                      });




                      //******************************************
                      Highcharts.chart('container44', {
                          chart: {
                              type: 'column'
                          },
                          xAxis: {
                              categories: arrRegionalDir
                          },

                          plotOptions: {
                              series: {
                                  dataLabels: {
                                      enabled: true,
                                      align: 'right',
                                      color: '#FFFFFF',
                                      x: -10
                                  },
                                  pointPadding: 0.1,
                                  groupPadding: 0
                              }
                          },
                            colors: colors,
                            title: {
                                text: 'Nombre des anomalies par journée (mois '+moisAnnAct+')'
                            },

                          series: [{
                              name: "Nombre des anomalies par journée",
                              data: arrCRPercent
                          }]
                      });
                      

                      //******************************************

                     }
                      
                    
                      
                      
                  }
              });
          }
        LoadCharts();
        function loadPreviousInfo(arrMois,arrSumMoiCr,arrSumMoiAnnomalie,date1,date2,label,counter) {
          console.log('counter= '+counter);
          var limit1=date1+'T00:00:00.000';
          var limit2=date2+'T00:00:00.000';
          var urlPreviousInfo= _spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('ControlPlus')/items?$filter=Date_x0020_Journ_x00e9_e ge datetime'"+limit1+"' and Date_x0020_Journ_x00e9_e lt datetime'"+limit2+"' and Avis_x0020_DCP%20eq%27Vérifiée%27";
          var responsePreviousInfo=responsePreviousInfo||[];
          function loadInfoF() {
              var nbre = 0;


              $.ajax({
                  url: urlPreviousInfo,
                  method: "GET",
                  dataType: "json",
                  headers: { Accept: "application/json;odata=verbose" },
                  success: function (data) {
                      responsePreviousInfo = responsePreviousInfo.concat(data.d.results);
                      if (data.d.__next) {
                          urlPreviousInfo = data.d.__next;
                          loadInfoF();
                      }
                      else if (!data.d.__next) {
                        

                        var sumCr=0;
                        var sumAnn=0;
                        $.each(responsePreviousInfo, function (key, value) {
                          sumCr++;
                          
                          var nbNonConforme=0;
                          if (value.N_x00b0__x0020_Non_x0020_Conform!=null) {
                            nbNonConforme=value.N_x00b0__x0020_Non_x0020_Conform;
                          }
                          
                            sumAnn=parseInt(sumAnn+nbNonConforme);
                        });
                          ////console.log("arrCRCount= "+arrCRCount);
                          
                          arrMois[counter]=label;
                          arrSumMoiCr[counter]=sumCr;
                          arrSumMoiAnnomalie[counter]=sumAnn;
                          
                          if (counter==1) {
                            //***********************+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                            var rappCrAnnomalie0=[];
                            for (var k = 0; k < arrMois.length; k++) {
                              if (arrSumMoiAnnomalie[k]==0||arrSumMoiCr[k]==0) {
                                rappCrAnnomalie0[k]=0;
                              }
                              else{
                                var newRapport=parseFloat(parseFloat(arrSumMoiAnnomalie[k])/parseFloat(arrSumMoiCr[k])).toFixed(2);
                                rappCrAnnomalie0[k]=parseFloat(newRapport);
                              }
                            }
                              var moisAnnAct11=moment().format("MM-YYYY");
                              Highcharts.chart('container2', {
                              chart: {
                                  type: 'bar'
                              },
                              xAxis: {
                                  categories: arrMois
                              },

                              plotOptions: {
                                  series: {
                                      dataLabels: {
                                          enabled: true,
                                          align: 'right',
                                          color: '#FFFFFF',
                                          x: -10
                                      },
                                      pointPadding: 0.1,
                                      groupPadding: 0
                                  }
                              },
                                colors: colors,
                                title: {
                                    text: 'En matière de contrôle permanant du réseau (mois '+moisAnnAct11+')'
                                },

                              series: [{
                                  name: "Anomalies/CR",
                                  data: rappCrAnnomalie0
                              }]
                          });
                          //++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
                            var anneeAct=moment().format("YYYY");
                            var annPass=moment(anneeAct).add(-1, 'year').format('YYYY');
                            var limitYear1=annPass+"-01-01T00:00:00.000";
                            var limitYear2=annPass+"-12-31T00:00:00.000";
                            
                            loadInfoPrevYear(limitYear1,limitYear2,arrMois,arrSumMoiCr,arrSumMoiAnnomalie);
                          }
                          
                     }
                      
                    
                      
                      
                  }
              });
          }
        loadInfoF();
        }
        function loadInfoPrevYear(limitYear1,limitYear2,arrMois,arrSumMoiCr,arrSumMoiAnnomalie){
          var urlPreviousYear= _spPageContextInfo.siteAbsoluteUrl + "/_api/web/lists/getbytitle('ControlPlus')/items?$select=N_x00b0__x0020_Non_x0020_Conform&$filter=Date_x0020_Journ_x00e9_e ge datetime'"+limitYear1+"' and Date_x0020_Journ_x00e9_e le datetime'"+limitYear2+"' and Avis_x0020_DCP%20eq%27Vérifiée%27";
          var responsePreviousYear=responsePreviousYear||[];
    function loaddPreviousYear() {
              var nbre = 0;


              $.ajax({
                  url: urlPreviousYear,
                  method: "GET",
                  dataType: "json",
                  headers: { Accept: "application/json;odata=verbose" },
                  success: function (data) {
                      responsePreviousYear = responsePreviousYear.concat(data.d.results);
                      if (data.d.__next) {
                          urlPreviousYear = data.d.__next;
                          loaddPreviousYear();
                      }
                      else if (!data.d.__next) {
                        

                        var sumCr=0;
                        var sumAnn=0;
                        $.each(responsePreviousYear, function (key, value) {
                          sumCr++;
                          
                          var nbNonConforme=0;
                          if (value.N_x00b0__x0020_Non_x0020_Conform!=null) {
                            nbNonConforme=value.N_x00b0__x0020_Non_x0020_Conform;
                          }
                          
                            sumAnn=parseInt(sumAnn+nbNonConforme);
                        });
                          ////console.log("arrCRCount= "+arrCRCount);
                          var labYer="Moyenne- "+moment().add(-1, 'year').format('YYYY');
                          arrMois.push(labYer);
                          arrSumMoiCr.push(sumCr);
                          arrSumMoiAnnomalie.push(sumAnn);
                         // //console.log("arrMois= "+arrMois);
                         //    //console.log("arrSumMoiCr= "+arrSumMoiCr);
                         //    //console.log("arrSumMoiAnnomalie= "+arrSumMoiAnnomalie);
                            var rappCrAnnomalie=[];
                            for (var i = 0; i < arrMois.length; i++) {
                              if (arrSumMoiAnnomalie[i]==0||arrSumMoiCr[i]==0) {
                                rappCrAnnomalie[i]=0;
                              }
                              else{
                                var newRapport=parseFloat(parseFloat(arrSumMoiAnnomalie[i])/parseFloat(arrSumMoiCr[i])).toFixed(2);
                                rappCrAnnomalie[i]=parseFloat(newRapport);
                              }
                            }
                            var tauxMois=0;
                            var tauxMoisAnn=0;
                            if (rappCrAnnomalie[1]!=0) {
                              tauxMois=parseFloat(((rappCrAnnomalie[1]-rappCrAnnomalie[0])/rappCrAnnomalie[1])*100).toFixed(2);
                            }
                            if (rappCrAnnomalie[2]!=0) {
                              tauxMoisAnn=parseFloat(((rappCrAnnomalie[2]-rappCrAnnomalie[0])/rappCrAnnomalie[2])*100).toFixed(2);
                            }
                            var annPred=moment().add(-1, 'year').format('YYYY');
                            var moisPred=moment().add(-1, 'month').format('MM');
                            var mois=moment().format('MM');
                            ch1="Taux d'amélioration Moyenne M"+mois+"/ Moy. M"+moisPred;
                            ch2="Taux d'amélioration Moyenne M"+mois+"/ Moy. A-"+annPred;
                            //console.log("tauxMoisAnn= "+tauxMoisAnn);
                            document.getElementById("titre1").innerHTML ='<a class="list-group-item" style="font-size: 17px;color: #000; margin-top: 0%;margin-bottom: 25%;">'+ch1+'</a>';
                            document.getElementById("titre2").innerHTML ='<a class="list-group-item" style="font-size: 17px;color: #000; margin-top: 0%;margin-bottom: 25%;">'+ch2+'</a>';
                            //image1 value1 titre1 image2 value2 titre2
                            if (tauxMois<0) {
                              document.getElementById("image1").innerHTML ="<img src='/sites/bhcom/_catalogs/masterpage/ConformiteControle/img/vert.png' class='img-rounded' alt='Cinque Terre' width='40%' height='40%' style='margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;'>";
                              document.getElementById("value1").innerHTML ='<a href="#" class="list-group-item" style="font-size: 17px;color: #fff; background-color: #35ab0e;margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%; width:40%;">'+tauxMois+'%</a>';
                            }
                            else if (tauxMois==0) {
                              document.getElementById("image1").innerHTML ="<img src='/sites/bhcom/_catalogs/masterpage/ConformiteControle/img/jaune.png' class='img-rounded' alt='Cinque Terre' width='40%' height='40%' style='margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;'>";
                              document.getElementById("value1").innerHTML ='<a href="#" class="list-group-item" style="font-size: 17px;color: #fff; background-color: #ff5722;margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;width:40%;">'+tauxMois+'%</a>';
                            }
                            else if (tauxMois>0) {
                              document.getElementById("image1").innerHTML ="<img src='/sites/bhcom/_catalogs/masterpage/ConformiteControle/img/rouge.png' class='img-rounded' alt='Cinque Terre' width='40%' height='40%' style='margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;'>";
                              document.getElementById("value1").innerHTML ='<a href="#" class="list-group-item" style="font-size: 17px;color: #fff; background-color: #d13a36;margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;width:40%;">'+tauxMois+'%</a>';
                            }
                            console.log('tauxMoisAnn= '+tauxMoisAnn);
                            if (tauxMoisAnn<0) {
                              document.getElementById("image2").innerHTML ="<img src='/sites/bhcom/_catalogs/masterpage/ConformiteControle/img/vert.png' class='img-rounded' alt='Cinque Terre' width='40%' height='40%' style='margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;'>";
                              document.getElementById("value2").innerHTML ='<a href="#" class="list-group-item" style="font-size: 17px;color: #fff; background-color: #35ab0e;margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;width:40%;">'+tauxMoisAnn+'%</a>';
                            }
                            else if (tauxMoisAnn==0) {
                              //console.log('00000')
                              document.getElementById("image2").innerHTML ="<img src='/sites/bhcom/_catalogs/masterpage/ConformiteControle/img/jaune.png' class='img-rounded' alt='Cinque Terre' width='40%' height='40%' style='margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;'>";
                              document.getElementById("value2").innerHTML ='<a href="#" class="list-group-item" style="font-size: 17px;color: #fff; background-color: #ff5722;margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;width:40%;">'+tauxMoisAnn+'%</a>';
                            }
                            else if (tauxMoisAnn>0) {
                              document.getElementById("image2").innerHTML ="<img src='/sites/bhcom/_catalogs/masterpage/ConformiteControle/img/rouge.png' class='img-rounded' alt='Cinque Terre' width='40%' height='40%' style='margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;'>";
                              document.getElementById("value2").innerHTML ='<a href="#" class="list-group-item" style="font-size: 17px;color: #fff; background-color: #d13a36;margin-left: 25%;margin-right: 25%;margin-top: 0%;margin-bottom: 5%;width:40%;">'+tauxMoisAnn+'%</a>';
                            }
                            ////console.log("rappCrAnnomalie= "+rappCrAnnomalie);
                            
                     }
                      
                    
                      
                      
                  }
              });
          }
        loaddPreviousYear();
        }
</script>
    
</body>